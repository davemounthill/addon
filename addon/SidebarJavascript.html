<script>
  // Global variables
  var csvData = null;
  var columnMappings = {};

  // Event listener for the "Upload CSV" button
  document.getElementById('file-import').addEventListener('change', function(event) {
    var file = event.target.files[0];
    var reader = new FileReader();
    reader.onload = function(event) {
      csvData = event.target.result;
      displayFileInfo(file);
      displayPreviewTable();
    };
    reader.readAsText(file);
  });

  // Event listener for the "Save Mapping" button
  document.getElementById('save-button').addEventListener('click', function() {
    saveMapping();
  });

  // Event listener for the "Clear Mapping" button
  document.getElementById('clear-button').addEventListener('click', function() {
    clearMapping();
    clearPreviewTable();
  });

  // Function to display file information
  function displayFileInfo(file) {
    var fileName = file.name;
    var fileSize = formatFileSize(file.size);
    var uploadTime = formatUploadTime(file.lastModified);
    
    // Display file information
    document.getElementById('file-info').textContent = 'File: ' + fileName;
    document.getElementById('file-size').textContent = 'Size: ' + fileSize;
    document.getElementById('upload-time').textContent = 'Uploaded: ' + uploadTime;
  }

  // Function to format file size
  function formatFileSize(fileSize) {
    if (fileSize < 1024) {
      return fileSize + ' B';
    } else if (fileSize < 1048576) {
      return (fileSize / 1024).toFixed(2) + ' KB';
    } else {
      return (fileSize / 1048576).toFixed(2) + ' MB';
    }
  }

  // Function to format upload time
  function formatUploadTime(uploadTime) {
    var date = new Date(uploadTime);
    return date.toLocaleString();
  }

  // Function to display the preview table
  function displayPreviewTable() {
    var previewTable = document.getElementById('preview-table');
    previewTable.innerHTML = '';

    if (csvData) {
      var rows = csvData.split('\n');
      var headerRow = rows[0].split(',');

      // Create table header row
      var thead = document.createElement('thead');
      var headerRowElement = document.createElement('tr');

      for (var i = 0; i < headerRow.length; i++) {
        var th = document.createElement('th');
        th.textContent = headerRow[i];
        headerRowElement.appendChild(th);
      }

      thead.appendChild(headerRowElement);
      previewTable.appendChild(thead);

      // Create table body rows
      var tbody = document.createElement('tbody');

      for (var j = 1; j < rows.length; j++) {
        var row = rows[j].split(',');
        var bodyRowElement = document.createElement('tr');

        for (var k = 0; k < row.length; k++) {
          var td = document.createElement('td');
          td.textContent = row[k];
          bodyRowElement.appendChild(td);
        }

        tbody.appendChild(bodyRowElement);
      }

      previewTable.appendChild(tbody);
    }
  }

  // Function to save the column mappings
  function saveMapping() {
    var selectElements = document.querySelectorAll('.column-mapping');
    columnMappings = {};

    selectElements.forEach(function(selectElement) {
      var csvColumn = selectElement.getAttribute('data-csv-column');
      var googleSheetColumn = selectElement.value;

      if (googleSheetColumn !== '') {
        columnMappings[csvColumn] = googleSheetColumn;
      }
    });

    // Save the column mappings using Google Apps Script
    google.script.run.saveMappings(columnMappings, function(response) {
      alert(response);
    });
  }

  // Function to clear the column mappings
  function clearMapping() {
    var selectElements = document.querySelectorAll('.column-mapping');
    columnMappings = {};

    selectElements.forEach(function(selectElement) {
      selectElement.value = '';
    });

    // Clear the column mappings using Google Apps Script
    google.script.run.clearMappings(function(response) {
      alert(response);
    });
  }

  // Function to clear the preview table
  function clearPreviewTable() {
    var previewTable = document.getElementById('preview-table');
    previewTable.innerHTML = '';
  }
</script>
